<html>
<head>
    <script>


        var pipicycle = function(){
            this.map = [
                [100, 40],
                [900, 120],
                [1600, 50],
                [1800, 60],
                [3000, 100]
            ];
            this.player_y = 30;
            this.player_x = 0;
            var c = document.getElementById("game");
            this.game_canvas_2d = c.getContext("2d");
            this.assets = {
                "pixel-city-daytime.png": new Image(),
                "cat.png": new Image(),
                "pipe_up.png": new Image(),
                "pipe_down.png": new Image()
            };
            this.preload_assets(this.assets);
            this.last_render = 0;

            var that = this;
            document.onkeypress = function(){
                that.player_y-=20;
            }

        }

        pipicycle.prototype.start = function(){
            console.log("starting");
            var that = this;
            that.main_loop();
            this.timer = setInterval(function(){that.main_loop()}, 1);
        }

        pipicycle.prototype.render_map = function(){
            that = this;
            this.map.forEach(function(arr){
                if(arr[0] > that.player_x - that.assets["pipe_up.png"].width){

                    that.game_canvas_2d.drawImage(that.assets["pipe_up.png"],arr[0] - that.player_x , 600-((arr[1]/100)*300));
                    that.game_canvas_2d.drawImage(that.assets["pipe_down.png"],arr[0] - that.player_x , 600-((arr[1]/100)*300) - 600);

                }

            });

        }

        pipicycle.prototype.main_loop = function(){
            var t = Date.now();
            this.game_canvas_2d.drawImage(this.assets["pixel-city-daytime.png"],0, 0, 800, 600);
            this.game_canvas_2d.drawImage(this.assets["cat.png"],100, this.player_y);
            this.render_map();


            if( (t - this.last_render) > 10){
                this.last_render = Date.now();
                this.player_y++;
                this.player_x++;


            }


        }

        pipicycle.prototype.preload_assets = function(assets){ //ARRAY
            console.log("Loading assets");
            var num = Object.keys(assets).length;
            console.log(num + " of assets to load");

            that = this;
            for (var image in assets){
                console.log("loading" + image);
                var img = assets[image];

                img.src = image;
                img.onload = function(){
                    --num;
                    if(num === 0){
                         that.start();
                    }
                }
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
            var game = new pipicycle();
        });


    </script>

    <style>
        canvas {
             border: 1px solid #000;
        }
    </style>
</head>
<body>
    <canvas width="800" height="600" id="game"></canvas>

</body>
</html>
